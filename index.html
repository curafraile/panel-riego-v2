<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Panel de Riego</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; background: #f0f0f0; }
    h1 { color: #2c3e50; }
    .dato { font-size: 2em; margin: 1em 0; padding: 0.5em; border-radius: 10px; display: inline-block; }
    .riego, .origen { margin-top: 1em; font-weight: bold; color: #2980b9; }
    button { padding: 1em 2em; font-size: 1em; margin: 0.5em; border: none; border-radius: 5px; cursor: pointer; color: white; }
    button:hover { opacity: 0.9; }
    .on { background: #27ae60; }
    .off { background: #c0392b; }
    .auto { background: #3498db; }
    .manual { background: #8e44ad; }
    canvas { margin-top: 2em; }
  </style>
</head>
<body>
  <h1>🌱 Panel de Riego</h1>
  <div id="humedadBox" class="dato">Humedad actual: <span id="humedad">--</span>%</div>
  <div class="riego">Estado de riego: <span id="estadoRiego">--</span></div>
  <div class="origen">Origen del cambio: <span id="origenRiego">--</span></div>
  <button class="on" onclick="activarRiego()">Activar riego</button>
  <button class="off" onclick="desactivarRiego()">Desactivar riego</button>
  <button class="auto" onclick="activarAutomatico()">Modo automático</button>
  <button class="manual" onclick="activarManual()">Modo manual</button>

  <canvas id="graficoHumedad" width="400" height="200"></canvas>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAzXHzQBJHt60kQ14X4a7OZ3fJVdoHGBk8",
      authDomain: "riego-hibrido.firebaseapp.com",
      databaseURL: "https://riego-hibrido-default-rtdb.firebaseio.com",
      projectId: "riego-hibrido",
      storageBucket: "riego-hibrido.appspot.com",
      messagingSenderId: "283637108482",
      appId: "1:283637108482:web:7acc8ccb8b188087cd7c1b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Lectura de humedad
    db.ref("riego/humedad").on("value", snapshot => {
      const valor = snapshot.val();
      const humedad = document.getElementById("humedad");
      const box = document.getElementById("humedadBox");
      humedad.textContent = valor ?? "--";

      if (valor < 30) {
        box.style.background = "#e74c3c"; // rojo: seco
      } else if (valor < 60) {
        box.style.background = "#f1c40f"; // amarillo: intermedio
      } else {
        box.style.background = "#2ecc71"; // verde: húmedo
      }
    });

    // Lectura del estado de riego
    db.ref("riego/bomba").on("value", snapshot => {
      const estado = snapshot.val();
      document.getElementById("estadoRiego").textContent = estado ?? "--";
    });

    // Lectura del origen
    db.ref("riego/origen").on("value", snapshot => {
      const origen = snapshot.val();
      document.getElementById("origenRiego").textContent = origen ?? "--";
    });

    // Activación manual
    function activarRiego() {
      db.ref("riego/bomba").set("ON");
      db.ref("riego/origen").set("manual");
      alert("💧 Riego activado manualmente");
    }

    // Desactivación manual
    function desactivarRiego() {
      db.ref("riego/bomba").set("OFF");
      db.ref("riego/origen").set("manual");
      alert("🛑 Riego desactivado manualmente");
    }

    // Activación de modo automático
    function activarAutomatico() {
      db.ref("riego/origen").set("auto");
      alert("🔄 Modo automático activado");
    }

    // Activación de modo manual sin cambiar bomba
    function activarManual() {
      db.ref("riego/origen").set("manual");
      alert("🧑‍🔧 Modo manual activado");
    }

    // Gráfico de humedad en tiempo real
    const ctx = document.getElementById("graficoHumedad").getContext("2d");
    const grafico = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Humedad (%)",
          data: [],
          borderColor: "#27ae60",
          backgroundColor: "rgba(39,174,96,0.2)",
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: "Hora" } },
          y: { min: 0, max: 100, title: { display: true, text: "Humedad (%)" } }
        }
      }
    });

    db.ref("riego/log").on("value", snapshot => {
      const datos = snapshot.val();
      const etiquetas = [];
      const valores = [];

      for (const timestamp in datos) {
        const fecha = new Date(parseInt(timestamp));
        etiquetas.push(fecha.toLocaleTimeString());
        valores.push(datos[timestamp]);
      }

      grafico.data.labels = etiquetas;
      grafico.data.datasets[0].data = valores;
      grafico.update();
    });
  </script>
</body>
</html>
